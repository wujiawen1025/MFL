/*
========================================================================================================================
**【文件描述】                                        【文件描述】                                        【文件描述】**
========================================================================================================================
**    文件名称：ESF_Mem.c 
**
**    功能描述: 内存块的管理 
**
**    项目名称：Easy SoftWare FrameWork (简单 软件框架)
**
**    平台信息：
**
**    作    者：Hzy
**
**    版    本：V1.0
**
**    其他说明: 使用固定大小的内存块，使用单链表进行管理
**
**    修改记录: --------------------------------------------------------------
**              2015.08    
**              完成 V1.0 版本
**              --------------------------------------------------------------
**              2016.06 
**              升级到V1.1版本。主要是为了简化有关事件和内存分配释放的使用。
**              1、去掉事件内存池相关内容。 
**              2、修改 ESF_Evt_t结构体，增加变量AppendData[1]; 
**              3、修改 ESF_Cfg.h文件，使得配置功能更明了简便。
**
========================================================================================================================
========================================================================================================================
*/

/*
========================================================================================================================
* 【文件包含】                                         【文件包含】                                          【文件包含】
========================================================================================================================
*/
#include "ESF_Mem.h"


/*
========================================================================================================================
*【本地宏定义】                                       【本地宏定义】                                       【本地宏定义】
========================================================================================================================
*/

/*
========================================================================================================================
*【本地数据类型定义】                              【本地数据类型定义】                              【本地数据类型定义】
========================================================================================================================
*/
typedef struct 
{
  uint8_t          Used[ESF_MEM_BOLCK_NUM];    
  ESF_MemUnit_t    BlkBuf[ESF_MEM_BOLCK_NUM][ESF_MEM_BOLCK_SIZE]; 
}ESF_Mem_t;


/*
========================================================================================================================
*【变量定义 & 各种声明】                          【变量定义 & 各种声明】                          【变量定义 & 各种声明】    
========================================================================================================================
*/
ESF_Mem_t      ESF_Mem;


/*
========================================================================================================================
*【函数定义】                                          【函数定义】                                          【函数定义】
========================================================================================================================
*/
/*
************************************************************************************************************************
* 函数名称 : ESF_MemBuf_Init                                                                                                         
* 功能描述 : 内存块的初始化                                                                              
* 输入参数 : 无                                                                                      
* 返回参数 : 无                                                                 
* 补充说明 : 无                                                                                                         
************************************************************************************************************************
*/
void ESF_MemBuf_Init(void)
{
  memset(&ESF_Mem, 0, sizeof(ESF_Mem));
}


/*
************************************************************************************************************************
* 函数名称 : ESF_MemBuf_Get                                                                                                         
* 功能描述 : 获取一个空闲的内存块                                                                           
* 输入参数 : 无                                                                                      
* 返回参数 : 失败 -- 0指针
             成功 -- 指向申请到的内存块的指针                                                                 
* 补充说明 : 无                                                                                                         
************************************************************************************************************************
*/
void*  ESF_MemBuf_Get(void)
{
  uint8_t i;
  
  ESF_EnterCritical();
  for(i=0; i<ESF_MEM_BOLCK_NUM; i++)
  {
    if(FALSE == ESF_Mem.Used[i])
    {
      ESF_Mem.Used[i] = TRUE;
      ESF_ExitCritical();
      return &ESF_Mem.BlkBuf[i][0];
    }
  }
  
  ESF_ExitCritical();
  return NULL;
}


/*
************************************************************************************************************************
* 函数名称 : ESF_MemBuf_Free                                                                                                         
* 功能描述 : 将内存块释放                                                                    
* 输入参数 : Free 要释放的内存块                                                                                             
* 返回参数 : EFS_ERR_MEM_FULL         -- 内存池满
*            EFS_ERR_NONE             -- 成功
*            EFS_ERR_MEM_INVALID_ADDR -- pFree指向的地址无效                                                                 
* 补充说明 : 无                                                                                                         
************************************************************************************************************************
*/
uint8_t ESF_MemBuf_Free(void *pFree)
{
  uint8_t i;
 
  ESF_EnterCritical();
  for(i=0; i<ESF_MEM_BOLCK_NUM; i++)
  {
    if(pFree == (uint8_t *)&ESF_Mem.BlkBuf[i][0])  
    {
      ESF_Mem.Used[i] = FALSE;
      ESF_ExitCritical();
      return EFS_ERR_NONE;
    }
  }

  ESF_ExitCritical();
  return EFS_ERR_MEM_INVALID_ADDR;
}

